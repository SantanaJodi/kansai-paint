image: docker:latest

services:
  - docker:dind

stages:
  - build-http

before_script:
  # Login to Google Container Registry
  - base64 -d $GCP_SA_KEY | docker login -u _json_key --password-stdin https://gcr.io

build-http:
  stage: build-http
  only:
    - staging
  script:
    # Build and tag image for both GCR and Gitlab registries
    - docker build -t gcr.io/$GCP_PROJECT_ID/$APP_NAME_KANSAI_GOSHOCK_MICROSITE_STAGING:latest -t gcr.io/$GCP_PROJECT_ID/$APP_NAME_KANSAI_GOSHOCK_MICROSITE_STAGING:$CI_PIPELINE_ID .
    # Push image to GCR
    - docker push gcr.io/$GCP_PROJECT_ID/$APP_NAME_KANSAI_GOSHOCK_MICROSITE_STAGING:latest
    - docker push gcr.io/$GCP_PROJECT_ID/$APP_NAME_KANSAI_GOSHOCK_MICROSITE_STAGING:$CI_PIPELINE_ID
